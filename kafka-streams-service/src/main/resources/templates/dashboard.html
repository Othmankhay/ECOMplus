<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ECOMplus Real-Time Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; }
        .stat-card { text-align: center; padding: 20px; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: #0d6efd; }
        .stat-label { color: #6c757d; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        .live-indicator {
            display: inline-block; width: 10px; height: 10px; background-color: #dc3545;
            border-radius: 50%; margin-right: 5px; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #connection-status { position: fixed; bottom: 10px; right: 10px; z-index: 1000; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
            <span class="live-indicator"></span> ECOMplus Real-Time Stream Analytics
        </span>
        <span class="text-white" id="clock">00:00:00</span>
    </div>
</nav>

<div class="container-fluid px-4">
    
    <!-- Top Stats Row -->
    <div class="row">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="stat-value" id="totalRevenue">$0.00</div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="stat-value" id="totalPageViews">0</div>
                <div class="stat-label">Total Page Views</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="stat-value text-success">Active</div>
                <div class="stat-label">System Status</div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Orders by Status (Real-time)</div>
                <div class="card-body">
                    <canvas id="ordersChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Action Counts</div>
                <div class="card-body">
                    <canvas id="actionsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">Top Pages Viewed</div>
                <div class="card-body">
                    <canvas id="pagesChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Events Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">Live Analytics Events Feed</div>
                <div class="card-body p-0">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Type</th>
                                <th>Key</th>
                                <th>Count/Value</th>
                                <th>Window Start</th>
                            </tr>
                        </thead>
                        <tbody id="eventsTableBody">
                            <!-- Events will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="connection-status" class="badge bg-warning text-dark">Connecting...</div>

<script>
    // Utils
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
    }
    
    function updateClock() {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
    }
    setInterval(updateClock, 1000);

    // Charts Setup
    const ordersCtx = document.getElementById('ordersChart').getContext('2d');
    const ordersChart = new Chart(ordersCtx, {
        type: 'doughnut',
        data: {
            labels: ['CREATED', 'PROCESSING', 'SHIPPED', 'DELIVERED', 'CANCELLED'],
            datasets: [{
                data: [0, 0, 0, 0, 0],
                backgroundColor: ['#0d6efd', '#ffc107', '#198754', '#20c997', '#dc3545']
            }]
        }
    });

    const actionsCtx = document.getElementById('actionsChart').getContext('2d');
    const actionsChart = new Chart(actionsCtx, {
        type: 'bar',
        data: {
            labels: ['VIEW', 'CLICK', 'ADD_TO_CART', 'PURCHASE'],
            datasets: [{
                label: 'Count',
                data: [0, 0, 0, 0],
                backgroundColor: '#6f42c1'
            }]
        },
        options: {
            scales: { y: { beginAtZero: true } }
        }
    });
    
    const pagesCtx = document.getElementById('pagesChart').getContext('2d');
    const pagesChart = new Chart(pagesCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Page Views',
                data: [],
                backgroundColor: '#0dcaf0'
            }]
        },
        options: {
            indexAxis: 'y',
            scales: { x: { beginAtZero: true } }
        }
    });

    // WebSocket Connection
    let stompClient = null;

    function connect() {
        const socket = new SockJS('/ws-analytics');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // Disable debug logs
        
        stompClient.connect({}, function (frame) {
            document.getElementById('connection-status').className = 'badge bg-success';
            document.getElementById('connection-status').innerText = 'Connected';
            console.log('Connected: ' + frame);
            
            // Subscribe to stats
            stompClient.subscribe('/topic/stats', function (message) {
                updateDashboard(JSON.parse(message.body));
            });
            
            // Subscribe to live events
            stompClient.subscribe('/topic/analytics', function (message) {
                addEventToTable(JSON.parse(message.body));
            });
            
        }, function (error) {
            document.getElementById('connection-status').className = 'badge bg-danger';
            document.getElementById('connection-status').innerText = 'Disconnected';
            console.log('STOMP error: ' + error);
            setTimeout(connect, 5000);
        });
    }

    function updateDashboard(stats) {
        // Update counters
        document.getElementById('totalOrders').innerText = stats.totalOrders;
        document.getElementById('totalRevenue').innerText = formatCurrency(stats.totalRevenue);
        document.getElementById('totalPageViews').innerText = stats.totalPageViews;
        
        // Update Orders Chart
        const statusMap = stats.ordersByStatus || {};
        const statusOrder = ['CREATED', 'PROCESSING', 'SHIPPED', 'DELIVERED', 'CANCELLED'];
        ordersChart.data.datasets[0].data = statusOrder.map(s => statusMap[s] || 0);
        ordersChart.update();
        
        // Update Actions Chart
        const actionMap = stats.actionCounts || {};
        const actionOrder = ['VIEW', 'CLICK', 'ADD_TO_CART', 'PURCHASE'];
        actionsChart.data.datasets[0].data = actionOrder.map(a => actionMap[a] || 0);
        actionsChart.update();
        
        // Update Pages Chart (Top 5)
        const pagesMap = stats.pageViewsByPage || {};
        const sortedPages = Object.entries(pagesMap)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5);
        
        pagesChart.data.labels = sortedPages.map(([k]) => k);
        pagesChart.data.datasets[0].data = sortedPages.map(([,v]) => v);
        pagesChart.update();
    }
    
    function addEventToTable(event) {
        const tbody = document.getElementById('eventsTableBody');
        const row = tbody.insertRow(0);
        
        // Determine event type
        let type = 'Unknown';
        let key = '-';
        let count = 0;
        
        if (event.status) { type = 'ORDER_STATUS'; key = event.status; count = event.count; }
        else if (event.page) { type = 'PAGE_VIEW'; key = event.page; count = event.count; }
        else if (event.action) { type = 'USER_ACTION'; key = event.action; count = event.count; }
        
        row.innerHTML = `
            <td>${new Date().toLocaleTimeString()}</td>
            <td><span class="badge bg-secondary">${type}</span></td>
            <td>${key}</td>
            <td>${count}</td>
            <td>${event.window ? new Date(parseInt(event.window)).toLocaleTimeString() : '-'}</td>
        `;
        
        if (tbody.rows.length > 10) {
            tbody.deleteRow(10);
        }
    }

    // Initial load
    connect();
    
    // Fetch initial stats via API just in case
    fetch('/api/analytics/stats')
        .then(response => response.json())
        .then(data => updateDashboard(data))
        .catch(err => console.error('Error fetching stats:', err));

</script>
</body>
</html>
